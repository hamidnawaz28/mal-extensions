async function getAccessToken(){let[e]=await chrome.tabs.query({url:"https://asbestinventaris.ovam.be/*"});return{token:(await chrome.scripting.executeScript({target:{tabId:e.id},func:()=>JSON.parse(localStorage.getItem("oidc")).token}))[0].result,mainId:e?.url?.split("/").slice(4,-1)[0]}}async function create(e){try{let{token:t,mainId:s}=await getAccessToken(),n="https://asbestinventaris.ovam.be/v1/services/asbestinv/asbestinventaris",i=crypto.randomUUID();await fetch(`${n}/${s}/${e.type}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({inspectieficheId:i,beschrijving:e.json.beschrijving})});update(s,i,e)}catch(e){console.log(e)}}async function update(e,t,s){try{let n="https://asbestinventaris.ovam.be/v1/services/asbestinv/asbestinventaris",{token:i}=await getAccessToken(),a=await getVersion(e,t,s.type);s.json.id=t,s.json.asbestinventarisId=e,s.json.version=a;await fetch(`${n}/${e}/${s.type}/${t}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(s.json)})}catch(e){console.log(e)}}async function getVersion(e,t,s){try{let n="https://asbestinventaris.ovam.be/v1/services/asbestinv/asbestinventaris",{token:i}=await getAccessToken(),a=await fetch(`${n}/${e}/${s}/${t}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`}});return(await a.json()).version}catch(e){return console.log(e),"0"}}console.log("background.js"),chrome.runtime.onMessage.addListener(((e,t,s)=>{if(console.log("message",e),"create"===e.action)create(e.fiche),s("okay");else s("invalid command");return!0})),chrome.webRequest.onBeforeRequest.addListener((async function(e){if("POST"===e.method&&e.requestBody&&e.requestBody.raw&&"https://asbestinventaris.ovam.be"==e.initiator){const t=String.fromCharCode.apply(null,new Uint8Array(e.requestBody.raw[0].bytes));let s=await JSON.parse(t);if(s.id){let t={id:s.id+Math.random().toString(),mainId:e.url.split("/").slice(-3,-2)[0],json:s,type:e.url.split("/").slice(-2,-1)[0],isFavorite:!1};chrome.storage.local.get(null,(e=>{let s=e.fiches||[];s.push(t),s=s.sort(((e,t)=>e.json.beschrijving.toLowerCase()<t.json.beschrijving.toLowerCase()?-1:e.json.beschrijving.toLowerCase()>t.json.beschrijving.toLowerCase()?1:0)),e.subscriptionActive&&chrome.storage.local.set({fiches:s})}))}}}),{urls:["https://asbestinventaris.ovam.be/v1/services/asbestinv/asbestinventaris*"]},["requestBody"]);